var e=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))((function(c,o){function n(e){try{s(r.next(e))}catch(e){o(e)}}function i(e){try{s(r.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?c(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(n,i)}s((r=r.apply(e,t||[])).next())}))};function t(e,t){let a=4294967296*e.durationhi+e.duration,r=4294967296*e.ptshi+e.pts;"undefined"!=typeof LibAV&&LibAV.i64tof64&&(a=LibAV.i64tof64(e.duration,e.durationhi),r=LibAV.i64tof64(e.pts,e.ptshi));const c=Math.round(a*t.time_base_num/t.time_base_den*1e6);return{timestamp:Math.round(r*t.time_base_num/t.time_base_den*1e6),duration:c}}var a=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))((function(c,o){function n(e){try{s(r.next(e))}catch(e){o(e)}}function i(e){try{s(r.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?c(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(n,i)}s((r=r.apply(e,t||[])).next())}))};function r(e,t,a){const{timestamp:r,duration:c}=function(e,t){const a=t[1],r=t[2];return{timestamp:Math.round(e.timestamp*r/a/1e6),duration:Math.round(e.duration*r/a/1e6)}}(e,t);let o,n,i,s;"undefined"!=typeof LibAV&&LibAV.f64toi64?([o,n]=LibAV.f64toi64(r),[i,s]=LibAV.f64toi64(c)):(o=~~r,n=Math.floor(r/4294967296),i=~~c,s=Math.floor(c/4294967296));const d=new Uint8Array(e.byteLength);return e.copyTo(d.buffer),{data:d,pts:o,ptshi:n,dts:o,dtshi:n,stream_index:a,flags:0,duration:i,durationhi:s}}var c=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))((function(c,o){function n(e){try{s(r.next(e))}catch(e){o(e)}}function i(e){try{s(r.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?c(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(n,i)}s((r=r.apply(e,t||[])).next())}))};function o(e,t,a){let r=function(e,t){return!t&&e>=0||-1===t&&e<0?e:4294967296*t+e+(e<0?4294967296:0)}(e,t);return a&&(r=Math.round(1e6*r*a[0]/a[1])),r}const n=function(t,a){return e(this,void 0,void 0,(function*(){const e=yield t.avcodec_get_name(a.codec_id),r={codec:null,sampleRate:yield t.AVCodecParameters_sample_rate(a.codecpar),numberOfChannels:yield t.AVCodecParameters_channels(a.codecpar)},c=yield t.AVCodecParameters_extradata(a.codecpar);let o=null;if(c){const e=yield t.AVCodecParameters_extradata_size(a.codecpar);o=yield t.copyout_u8(c,e)}switch(e){case"flac":r.codec="flac",r.description=o;break;case"mp3":r.codec="mp3";break;case"aac":switch(yield t.AVCodecParameters_profile(a.codecpar)){case 1:r.codec="mp4a.40.2";break;case 4:r.codec="mp4a.40.5";break;case 28:r.codec="mp4a.40.29"}o&&(r.description=o);break;case"opus":r.codec="opus";break;case"vorbis":r.codec="vorbis",r.description=o;break;default:"undefined"!=typeof LibAVWebCodecs&&(r.codec={libavjs:{codec:e,ctx:{channels:yield t.AVCodecParameters_channels(a.codecpar),sample_rate:yield t.AVCodecParameters_sample_rate(a.codecpar)}}},o&&(r.description=o))}return r.codec?r:null}))},i=function(t,a){return e(this,void 0,void 0,(function*(){const e=yield t.avcodec_get_name(a.codec_id),r={codec:null,codedWidth:yield t.AVCodecParameters_width(a.codecpar),codedHeight:yield t.AVCodecParameters_height(a.codecpar)},c=yield t.AVCodecParameters_extradata(a.codecpar);let o=null;if(c){const e=yield t.AVCodecParameters_extradata_size(a.codecpar);o=yield t.copyout_u8(c,e)}let n=yield t.AVCodecParameters_profile(a.codecpar),i=yield t.AVCodecParameters_level(a.codecpar);switch(e){case"av1":{let e="av01";e+=`.0${n}`;let c=i.toString();c.length<2&&(c=`0${i}`);e+=`.${c}${"M"}`;const o=yield t.AVCodecParameters_format(a.codecpar),s=yield t.av_pix_fmt_desc_get(o);let d=(yield t.AVPixFmtDescriptor_comp_depth(s,0)).toString();d.length<2&&(d=`0${d}`),e+=`.${d}`;const l=yield t.AVPixFmtDescriptor_nb_components(s);e+=l<2?".1":".0";let f=0,u=0,p=0;l<2?(f=1,u=1):(f=yield t.AVPixFmtDescriptor_log2_chroma_w(s),u=yield t.AVPixFmtDescriptor_log2_chroma_h(s)),e+=`.${f}${u}${p}`,r.codec=e;break}case"h264":{let e="avc1";if(!o||o[0]|o[1]|o[2]||1!==o[3]||7!=(31&o[4])){n<0&&(n=77);const t=255&n;let a=t.toString(16);a.length<2&&(a=`0${a}`),e+=`.${a}`;let r=0;if(256&n)if(66===t)r|=224;else if(77===t)r|=96;else{if(88!==n)break;r|=32}let c=r.toString(16);c.length<2&&(c=`0${c}`),e+=c,i<0&&(i=10);let o=i.toString(16);o.length<2&&(o=`0${o}`),e+=o}else{e+=".";for(let t=5;t<=7;t++){let a=o[t].toString(16);a.length<2&&(a="0"+a),e+=a}}r.codec=e,o&&o[0]&&(r.description=o);break}case"hevc":{let e;if(o&&o.length>12){e="hvc1";const t=new DataView(o.buffer);r.description=o,e+=".";switch(o[1]>>6){case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C"}e+=(31&o[1])+".";let a=t.getUint32(2),c=0;for(let e=0;e<32&&(c|=1&a,31!==e);e++)c<<=1,a>>=1;e+=c.toString(16)+".";e+=0===(32&o[1])>>5?"L":"H";e+=o[12];let n="";for(let e=11;e>=6;e--){const t=o[e];(t||n)&&(n="."+t.toString(16)+n)}e+=n}else e=`hev1.${n}.4.L${i}.B01`;r.codec=e;break}case"vp8":r.codec="vp8";break;case"vp9":{let e="vp09",c=n.toString();n<0&&(c="00"),c.length<2&&(c=`0${c}`),e+=`.${c}`;let o=i.toString();i<0&&(o="10"),o.length<2&&(o=`0${o}`),e+=`.${o}`;const s=yield t.AVCodecParameters_format(a.codecpar),d=yield t.av_pix_fmt_desc_get(s);let l=(yield t.AVPixFmtDescriptor_comp_depth(d,0)).toString();"0"===l&&(l="08"),l.length<2&&(l=`0${l}`),e+=`.${l}`;const f=yield t.AVPixFmtDescriptor_log2_chroma_w(d),u=yield t.AVPixFmtDescriptor_log2_chroma_h(d);let p=0;p=f>0&&u>0?1:f>0||u>0?2:3,e+=`.0${p}`,e+=".1.1.1.0",r.codec=e;break}default:"undefined"!=typeof LibAVWebCodecs&&(r.codec={libavjs:{codec:e,ctx:{channels:yield t.AVCodecParameters_channels(a.codecpar),sample_rate:yield t.AVCodecParameters_sample_rate(a.codecpar)}}},o&&(r.description=o))}return r.codec?r:null}))},s=function(e,a,r={}){let c;c=r.EncodedAudioChunk?r.EncodedAudioChunk:EncodedAudioChunk;const{timestamp:o,duration:n}=t(e,a);return new c({type:"key",timestamp:o,duration:n,data:e.data.buffer})},d=function(e,a,r={}){let c;c=r.EncodedVideoChunk?r.EncodedVideoChunk:EncodedVideoChunk;const{timestamp:o,duration:n}=t(e,a);return new c({type:1&e.flags?"key":"delta",timestamp:o,duration:n,data:e.data.buffer})},l=function(e,t){return a(this,void 0,void 0,(function*(){const a=t.codec;let r;switch(r="object"==typeof a?a.libavjs.codec:a.replace(/\..*/,""),r){case"mp4a":r="aac";break;case"pcm-u8":r="pcm_u8";break;case"pcm-s16":r="pcm_s16le";break;case"pcm-s24":r="pcm_s24le";break;case"pcm-s32":r="pcm_s32le";break;case"pcm-f32":r="pcm_f32le"}const c=yield e.avcodec_descriptor_get_by_name(r),o=yield e.avcodec_parameters_alloc();c&&(yield e.AVCodecParameters_codec_type_s(o,yield e.AVCodecDescriptor_type(c)),yield e.AVCodecParameters_codec_id_s(o,yield e.AVCodecDescriptor_id(c)),t.sampleRate&&(yield e.AVCodecParameters_sample_rate_s(o,t.sampleRate)),t.numberOfChannels&&(yield e.AVCodecParameters_channels_s(o,t.numberOfChannels)));let n=1e3;return t.sampleRate&&(n=t.sampleRate),[o,1,n]}))},f=function(e,t){return a(this,void 0,void 0,(function*(){const a=t.codec;let r;switch(r="object"==typeof a?a.libavjs.codec:a.replace(/\..*/,""),r){case"av01":r="av1";break;case"avc1":case"avc3":r="h264";break;case"hev1":case"hvc1":r="hevc";break;case"vp09":r="vp9"}const c=yield e.avcodec_descriptor_get_by_name(r),o=yield e.avcodec_parameters_alloc();c&&(yield e.AVCodecParameters_codec_type_s(o,yield e.AVCodecDescriptor_type(c)),yield e.AVCodecParameters_codec_id_s(o,yield e.AVCodecDescriptor_id(c)),yield e.AVCodecParameters_width_s(o,t.width),yield e.AVCodecParameters_height_s(o,t.height));let n=1,i=1e3;if(t.framerate)if(t.framerate===~~t.framerate)i=t.framerate;else{const e=1001*t.framerate;if(e===~~e)n=1001,i=e;else for(i=t.framerate;i!==Math.floor(i);)n*=2,i*=2}return[o,n,i]}))},u=function(e,t,c,o,n){return a(this,void 0,void 0,(function*(){return r(t,o,n)}))},p=function(e,t,c,o,n){return a(this,void 0,void 0,(function*(){const a=r(t,o,n);if("key"===t.type&&(a.flags=1),o[0]&&c&&c.decoderConfig&&c.decoderConfig.description){const t=o[0];if(!(yield e.AVCodecParameters_extradata(t))){let a=c.decoderConfig.description;a=a.buffer?a.slice(0):new Uint8Array(a).slice(0);const r=yield e.malloc(a.length);yield e.copyin_u8(r,a),yield e.AVCodecParameters_extradata_s(t,r),yield e.AVCodecParameters_extradata_size_s(t,a.length)}}return a}))},m=function(e){return c(this,void 0,void 0,(function*(){const t=new Uint8Array(e.allocationSize());yield e.copyTo(t);let a=!0;"undefined"!=typeof LibAV&&LibAV&&LibAV.VER&&parseInt(LibAV.VER)<5&&(a=!1);let r=5,c=1,o=3,n=0,i=0;switch(e.format){case"I420":r=0,n=i=1;break;case"I420A":r=33,o=4,n=i=1;break;case"I422":r=4,n=1;break;case"NV12":r=23,o=2,i=1;break;case"RGBA":case"RGBX":r=26,o=1,c=4;break;case"BGRA":case"BGRX":r=28,o=1,c=4}const s={format:r,data:null,pts:~~e.timestamp,ptshi:Math.floor(e.timestamp/4294967296),width:e.visibleRect.width,height:e.visibleRect.height};if(a){const a=[];let r=0;for(let t=0;t<o;t++){let o=e.visibleRect.width,s=e.visibleRect.height;1!==t&&2!==t||(o>>=n,s>>=i),a.push({offset:r,stride:o*c}),r+=o*s*c}s.data=t,s.layout=a}else{s.data=[];let a=0;for(let r=0;r<o;r++){const o=[];s.data.push(o);let d=0,l=0;1!==r&&2!==r||(d=n,l=i);for(let r=0;r<e.visibleRect.height>>>l;r++){const r=e.visibleRect.width*c>>>d;o.push(t.subarray(a,a+r)),a+=r}}}return s}))},h=function(e){return c(this,void 0,void 0,(function*(){let t=6,a=Int16Array;const r=/-planar$/.test(e.format);switch(e.format){case"u8":case"u8-planar":t=r?5:0,a=Uint8Array;break;case"s16":case"s16-planar":t=r?6:1;break;case"s32":case"s32-planar":t=r?7:2,a=Int32Array;break;case"f32":case"f32-planar":t=r?8:3,a=Float32Array}const c={format:t,data:null,pts:~~e.timestamp,ptshi:Math.floor(e.timestamp/4294967296),sample_rate:e.sampleRate,nb_samples:e.numberOfFrames,channels:e.numberOfChannels};if(r){c.data=[];for(let t=0;t<e.numberOfChannels;t++){const r=new a(e.numberOfFrames);c.data.push(r),yield e.copyTo(r.buffer,{planeIndex:t,format:e.format})}}else{const t=c.data=new a(e.numberOfFrames*e.numberOfChannels);yield e.copyTo(t.buffer,{planeIndex:0,format:e.format})}return c}))},_=function(e,t={}){let a,r,c;a=t.VideoFrame?t.VideoFrame:VideoFrame;let n=[];if(e.layout)c=e.data,r=e.layout,t.transfer&&n.push(c.buffer);else{const t=[];let a=0;for(let r=0;r<e.data.length;r++){const c=e.data[r];t.push({offset:a,stride:c[0].length}),a+=c.length*c[0].length}const r=new Uint8Array(a);let c=0;for(let t=0;t<e.data.length;t++){const a=e.data[t],o=a[0].length;for(let e=0;e<a.length;e++)r.set(a[e],c),c+=o}n.push(r.buffer)}let i="I420";switch(e.format){case 0:i="I420";break;case 33:i="I420A";break;case 4:i="I422";break;case 23:i="NV12";break;case 26:i="RGBA";break;case 28:i="BGRA";break;default:throw new Error("Unsupported pixel format")}return new a(c,{format:i,codedWidth:e.width,codedHeight:e.height,timestamp:o(e.pts,e.ptshi,t.timeBase),layout:r,transfer:n})},b=function(e,t={}){let a;a=t.AudioData?t.AudioData:AudioData;let r=0;if(e.data.buffer)r=e.data.byteLength;else for(let t=0;t<e.data.length;t++)r+=e.data[t].byteLength;const c=new Uint8Array(r);if(e.data.buffer){const t=e.data;c.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}else{let t=0;for(let a=0;a<e.data.length;a++){const r=e.data[a],o=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);c.set(o,t),t+=o.length}}let n="s16";switch(e.format){case 0:n="u8";break;case 1:n="s16";break;case 2:n="s32";break;case 3:n="f32";break;case 5:n="u8-planar";break;case 6:n="s16-planar";break;case 7:n="s32-planar";break;case 8:n="f32-planar";break;default:throw new Error("Unsupported sample format")}return new a({format:n,data:c,sampleRate:e.sample_rate,numberOfFrames:e.nb_samples,numberOfChannels:e.channels,timestamp:o(e.pts,e.ptshi,t.timeBase)})};export{h as audioDataToLAFrame,n as audioStreamToConfig,l as configToAudioStream,f as configToVideoStream,u as encodedAudioChunkToPacket,p as encodedVideoChunkToPacket,b as laFrameToAudioData,_ as laFrameToVideoFrame,s as packetToEncodedAudioChunk,d as packetToEncodedVideoChunk,m as videoFrameToLAFrame,i as videoStreamToConfig};
